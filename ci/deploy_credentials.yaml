platform: linux
image_resource:
  type: docker-image
  source:
    repository: gcr.io/google.com/cloudsdktool/cloud-sdk
    tag: alpine
params:
  SERVICE_ACCOUNT_JSON: ((gcp.service_account_json))
  NOTIFY_API_KEY: ((eq-submission-confirmation.notify_api_key))
  PROJECT_ID:

run:
  path: bash
  args:
    - -exc
    - |
      export GOOGLE_APPLICATION_CREDENTIALS=~/gcloud-service-key.json
      cat >$GOOGLE_APPLICATION_CREDENTIALS <<EOL
      $SERVICE_ACCOUNT_JSON
      EOL

      KEY_NAME="notify_api_key"
      TEMP_FILE=$(mktemp)

      gcloud auth activate-service-account --key-file $GOOGLE_APPLICATION_CREDENTIALS
      gcloud config set project "${PROJECT_ID}"
      gcloud secrets create "$KEY_NAME" --replication-policy="automatic" || true

      # Store variable in file without xtrace enabled
      (
        set +x ;
        printf "%s" "$NOTIFY_API_KEY" > "$TEMP_FILE"
      )

      gcloud secrets versions add "$KEY_NAME" --data-file="$TEMP_FILE"

      # Give the default App Engine service account access to this secret
      gcloud secrets add-iam-policy-binding "$KEY_NAME" --role roles/secretmanager.secretAccessor \
        --member "serviceAccount:$PROJECT_ID@appspot.gserviceaccount.com"
